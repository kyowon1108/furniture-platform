# 시스템 아키텍처

## 개요

3D 가구 배치 플랫폼은 실시간 협업 기능을 갖춘 풀스택 애플리케이션입니다.

```
┌─────────────────────────────────────────────────────────────────┐
│                      클라이언트 레이어                            │
├─────────────────────────────────────────────────────────────────┤
│  Next.js 14 앱 (React 18 + TypeScript)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   페이지     │  │  컴포넌트    │  │   스토어     │          │
│  │  - 랜딩      │  │  - 3D 씬     │  │  - 인증      │          │
│  │  - 인증      │  │  - 가구      │  │  - 에디터    │          │
│  │  - 프로젝트  │  │  - UI        │  │  - Toast     │          │
│  │  - 에디터    │  │  - 툴바      │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │    훅        │  │     Lib      │  │    타입      │          │
│  │  - 키보드    │  │  - API       │  │  - 가구      │          │
│  │  - Socket    │  │  - Socket    │  │  - API       │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ HTTP/WebSocket
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        서버 레이어                                │
├─────────────────────────────────────────────────────────────────┤
│  FastAPI + Socket.IO (Python 3.9)                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  API 라우트  │  │  WebSocket   │  │    Core      │          │
│  │  - 인증      │  │  - 이벤트    │  │  - 보안      │          │
│  │  - 프로젝트  │  │  - 룸        │  │  - 충돌감지  │          │
│  │  - 레이아웃  │  │  - 브로드캐스트│  │            │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   모델       │  │   스키마     │  │  미들웨어    │          │
│  │  - User      │  │  - Pydantic  │  │  - CORS      │          │
│  │  - Project   │  │  - 검증      │  │  - 인증      │          │
│  │  - Layout    │  │              │  │              │          │
│  │  - History   │  │              │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ SQLAlchemy ORM
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      데이터베이스 레이어                          │
├─────────────────────────────────────────────────────────────────┤
│  SQLite (개발) / PostgreSQL (프로덕션)                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │    users     │  │   projects   │  │   layouts    │          │
│  │  - id        │  │  - id        │  │  - id        │          │
│  │  - email     │  │  - owner_id  │  │  - project_id│          │
│  │  - password  │  │  - name      │  │  - version   │          │
│  │  - ...       │  │  - room_*    │  │  - state     │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                   │
│  ┌──────────────┐                                                │
│  │   history    │                                                │
│  │  - id        │                                                │
│  │  - layout_id │                                                │
│  │  - changes   │                                                │
│  └──────────────┘                                                │
└─────────────────────────────────────────────────────────────────┘
```

## 통신 흐름

### 1. REST API 흐름 (HTTP)

```
사용자 액션 (프론트엔드)
    │
    ├─→ 로그인/회원가입
    │       │
    │       ├─→ POST /api/v1/auth/login
    │       │       │
    │       │       ├─→ 자격 증명 확인
    │       │       ├─→ JWT 토큰 생성
    │       │       └─→ 토큰 반환
    │       │
    │       └─→ localStorage에 토큰 저장
    │
    ├─→ 프로젝트 생성
    │       │
    │       ├─→ POST /api/v1/projects
    │       │       │
    │       │       ├─→ JWT 토큰 검증
    │       │       ├─→ DB에 프로젝트 생성
    │       │       ├─→ 초기 레이아웃 생성
    │       │       └─→ 프로젝트 데이터 반환
    │       │
    │       └─→ UI 업데이트
    │
    └─→ 레이아웃 저장
            │
            ├─→ POST /api/v1/projects/{id}/layouts
            │       │
            │       ├─→ JWT 토큰 검증
            │       ├─→ 가구 상태 검증
            │       ├─→ 데이터베이스에 저장
            │       └─→ 레이아웃 데이터 반환
            │
            └─→ 성공 Toast 표시
```

### 2. WebSocket 흐름 (실시간)

```
사용자 A: 가구 이동
    │
    ├─→ 로컬 상태 업데이트 (Zustand)
    │
    ├─→ 'furniture_move' 이벤트 발신
    │       │
    │       └─→ Socket.IO 클라이언트
    │               │
    │               └─→ WebSocket 연결
    │                       │
    │                       └─→ 백엔드 Socket.IO 서버
    │                               │
    │                               ├─→ 이벤트 검증
    │                               │
    │                               └─→ 룸에 브로드캐스트
    │                                       │
    │                                       ├─→ 사용자 B가 이벤트 수신
    │                                       │       │
    │                                       │       └─→ 가구 위치 업데이트
    │                                       │
    │                                       └─→ 사용자 C가 이벤트 수신
    │                                               │
    │                                               └─→ 가구 위치 업데이트
    │
    └─→ 업데이트된 3D 씬 렌더링
```

### 3. 충돌 감지 흐름

```
가구 이동
    │
    ├─→ 스토어에서 위치 업데이트
    │
    ├─→ WebSocket으로 발신
    │
    ├─→ 백엔드가 이벤트 수신
    │       │
    │       ├─→ 레이아웃의 모든 가구 가져오기
    │       │
    │       ├─→ 바운딩 박스 생성
    │       │
    │       ├─→ 충돌 검사 (O(n²))
    │       │       │
    │       │       ├─→ 각 쌍에 대해:
    │       │       │   ├─→ 2D 경계 가져오기 (XZ 평면)
    │       │       │   ├─→ 교차 확인
    │       │       │   └─→ 충돌 기록
    │       │       │
    │       │       └─→ 경계 확인
    │       │
    │       └─→ 'validation_result' 발신
    │
    └─→ 프론트엔드가 결과 수신
            │
            ├─→ 충돌 감지 시:
            │   ├─→ 가구를 충돌 상태로 표시
            │   ├─→ 색상을 빨간색으로 변경
            │   └─→ Toast 알림 표시
            │
            └─→ 3D 씬 업데이트
```

## 컴포넌트 아키텍처

### 프론트엔드 컴포넌트 트리

```
App
├── Layout (루트)
│   ├── 메타데이터
│   └── 전역 스타일
│
├── 랜딩 페이지
│   ├── 히어로 섹션
│   └── CTA 버튼
│
├── 인증 페이지
│   ├── 로그인
│   │   ├── 폼
│   │   └── 에러 표시
│   └── 회원가입
│       ├── 폼
│       └── 에러 표시
│
├── 프로젝트 페이지
│   ├── 프로젝트 목록
│   └── 생성 버튼
│
└── 에디터 페이지
    ├── Scene (3D 캔버스)
    │   ├── 카메라
    │   ├── 조명
    │   ├── 그리드
    │   ├── 방
    │   ├── 가구[]
    │   └── OrbitControls
    │
    ├── 툴바
    │   ├── Transform 버튼
    │   └── 그리드 스냅 토글
    │
    ├── 연결 상태
    │
    ├── Toast 컨테이너
    │   └── Toast[]
    │
    └── 저장 버튼
```

## 상태 관리 (Zustand)

### 인증 스토어
```typescript
{
  user: User | null,
  isAuthenticated: boolean,
  isLoading: boolean,
  login: (email, password) => Promise<void>,
  logout: () => void,
  fetchUser: () => Promise<void>
}
```

### 에디터 스토어
```typescript
{
  projectId: number | null,
  furnitures: FurnitureItem[],
  selectedIds: string[],
  transformMode: TransformMode,
  isGridSnap: boolean,
  // Undo/Redo
  historyStack: LayoutState[],
  canUndo: boolean,
  canRedo: boolean,
  // 측정
  measureMode: MeasureMode,
  measurePoints: Vector3[],
  // 조명
  timeOfDay: TimeOfDay,
  // 클립보드
  clipboard: FurnitureItem[]
}
```

## 보안 아키텍처

### 인증 흐름
```
1. 사용자가 자격 증명 제출
   ↓
2. 백엔드가 비밀번호 검증 (bcrypt)
   ↓
3. JWT 토큰 생성 (HS256)
   ↓
4. 클라이언트에 토큰 반환
   ↓
5. 클라이언트가 localStorage에 저장
   ↓
6. 클라이언트가 Authorization 헤더에 포함
   ↓
7. 백엔드가 각 요청마다 토큰 검증
   ↓
8. 토큰에서 사용자 추출
   ↓
9. 사용자 권한 확인
   ↓
10. 요청 처리
```

## 확장성 고려사항

### 현재 아키텍처 (Milestone 1-3)
- 단일 서버 인스턴스
- SQLite 데이터베이스
- 인메모리 WebSocket 룸
- 적합: 개발, 소규모 팀

### 향후 확장 경로
```
로드 밸런서
    │
    ├─→ 앱 서버 1 ─┐
    ├─→ 앱 서버 2 ─┼─→ Redis (세션/Socket 상태)
    └─→ 앱 서버 3 ─┘
            │
            └─→ PostgreSQL (Primary)
                    │
                    └─→ PostgreSQL (Replica)
```

## 기술 선택 이유

### FastAPI를 선택한 이유
- 현대적이고 빠른 Python 프레임워크
- 자동 API 문서 생성 (Swagger)
- 네이티브 async 지원
- 타입 힌트 및 검증
- 쉬운 WebSocket 통합

### Next.js를 선택한 이유
- 서버 사이드 렌더링 기능
- 파일 기반 라우팅
- 내장 최적화
- TypeScript 지원
- 풍부한 생태계

### Three.js를 선택한 이유
- WebGL 업계 표준
- 풍부한 생태계
- React Three Fiber로 선언적 3D
- 성능 최적화
- 광범위한 문서

### Zustand를 선택한 이유
- 최소한의 보일러플레이트
- Provider 불필요
- TypeScript 친화적
- 작은 번들 크기
- 테스트 용이

---

이 아키텍처는 명확한 관심사 분리, 확장 경로, 유지보수성을 갖춘 3D 가구 배치 플랫폼의 견고한 기반을 제공합니다.
