# ë°±ì—”ë“œ êµ¬ì¡° ìƒì„¸ ê°€ì´ë“œ

## ğŸ“‹ ëª©ì°¨
1. [ì•„í‚¤í…ì²˜ ê°œìš”](#ì•„í‚¤í…ì²˜-ê°œìš”)
2. [ë””ë ‰í† ë¦¬ êµ¬ì¡°](#ë””ë ‰í† ë¦¬-êµ¬ì¡°)
3. [í•µì‹¬ ëª¨ë“ˆ](#í•µì‹¬-ëª¨ë“ˆ)
4. [ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸](#ë°ì´í„°ë² ì´ìŠ¤-ëª¨ë¸)
5. [API ì—”ë“œí¬ì¸íŠ¸](#api-ì—”ë“œí¬ì¸íŠ¸)
6. [WebSocket ì´ë²¤íŠ¸](#websocket-ì´ë²¤íŠ¸)

---

## ì•„í‚¤í…ì²˜ ê°œìš”

ë°±ì—”ë“œëŠ” **FastAPI**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” RESTful APIì™€ **Socket.IO**ë¥¼ í†µí•œ ì‹¤ì‹œê°„ í†µì‹ ì„ ì œê³µí•©ë‹ˆë‹¤.

```
í´ë¼ì´ì–¸íŠ¸ ìš”ì²­
    â†“
FastAPI ë¯¸ë“¤ì›¨ì–´ (CORS, ì¸ì¦)
    â†“
API ë¼ìš°í„° (auth, projects, layouts)
    â†“
ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (core)
    â†“
ë°ì´í„°ë² ì´ìŠ¤ (SQLAlchemy ORM)
    â†“
SQLite / PostgreSQL / MySQL
```

---

## ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                 # FastAPI ì•± + Socket.IO í†µí•©
â”‚   â”œâ”€â”€ config.py               # í™˜ê²½ ì„¤ì •
â”‚   â”œâ”€â”€ database.py             # DB ì—°ê²° ë° ì„¸ì…˜ ê´€ë¦¬
â”‚   â”‚
â”‚   â”œâ”€â”€ models/                 # SQLAlchemy ëª¨ë¸
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py            # ì‚¬ìš©ì ëª¨ë¸
â”‚   â”‚   â”œâ”€â”€ project.py         # í”„ë¡œì íŠ¸ ëª¨ë¸
â”‚   â”‚   â”œâ”€â”€ layout.py          # ë ˆì´ì•„ì›ƒ ëª¨ë¸
â”‚   â”‚   â””â”€â”€ history.py         # íˆìŠ¤í† ë¦¬ ëª¨ë¸
â”‚   â”‚
â”‚   â”œâ”€â”€ schemas/                # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user.py            # ì‚¬ìš©ì ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â”œâ”€â”€ project.py         # í”„ë¡œì íŠ¸ ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â””â”€â”€ layout.py          # ë ˆì´ì•„ì›ƒ ìŠ¤í‚¤ë§ˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                    # API ì—”ë“œí¬ì¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py            # ì˜ì¡´ì„± (ì¸ì¦)
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”‚       â”œâ”€â”€ __init__.py
â”‚   â”‚       â”œâ”€â”€ auth.py        # ì¸ì¦ API
â”‚   â”‚       â”œâ”€â”€ projects.py    # í”„ë¡œì íŠ¸ API
â”‚   â”‚       â”œâ”€â”€ layouts.py     # ë ˆì´ì•„ì›ƒ API
â”‚   â”‚       â”œâ”€â”€ files.py       # íŒŒì¼ ì—…ë¡œë“œ API (PLY)
â”‚   â”‚       â””â”€â”€ websocket.py   # WebSocket ì„œë²„
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                   # í•µì‹¬ ë¡œì§
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ security.py        # JWT, ë¹„ë°€ë²ˆí˜¸ í•´ì‹±
â”‚   â”‚   â””â”€â”€ collision.py       # ì¶©ëŒ ê°ì§€
â”‚   â”‚
â”‚   â””â”€â”€ utils/                  # ìœ í‹¸ë¦¬í‹°
â”‚       â””â”€â”€ __init__.py
â”‚
â”œâ”€â”€ alembic/                    # DB ë§ˆì´ê·¸ë ˆì´ì…˜
â”‚   â”œâ”€â”€ env.py
â”‚   â”œâ”€â”€ script.py.mako
â”‚   â””â”€â”€ versions/
â”‚
â”œâ”€â”€ tests/                      # í…ŒìŠ¤íŠ¸
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ conftest.py            # í…ŒìŠ¤íŠ¸ ì„¤ì •
â”‚   â”œâ”€â”€ test_auth.py           # ì¸ì¦ í…ŒìŠ¤íŠ¸
â”‚   â”œâ”€â”€ test_projects.py       # í”„ë¡œì íŠ¸ í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ test_collision.py      # ì¶©ëŒ ê°ì§€ í…ŒìŠ¤íŠ¸
â”‚
â”œâ”€â”€ .env                        # í™˜ê²½ ë³€ìˆ˜
â”œâ”€â”€ .env.example                # í™˜ê²½ ë³€ìˆ˜ ì˜ˆì œ
â”œâ”€â”€ requirements.txt            # Python ì˜ì¡´ì„±
â””â”€â”€ alembic.ini                 # Alembic ì„¤ì •
```

---

## í•µì‹¬ ëª¨ë“ˆ

### 1. main.py - FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜

**ì—­í• **: FastAPI ì•± ì´ˆê¸°í™”, ë¯¸ë“¤ì›¨ì–´ ì„¤ì •, ë¼ìš°í„° ë“±ë¡

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
import socketio

app = FastAPI(title="Furniture Platform API")

# CORS ì„¤ì •
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.origins_list,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# API ë¼ìš°í„° ë“±ë¡
app.include_router(auth.router, prefix="/api/v1/auth")
app.include_router(projects.router, prefix="/api/v1/projects")
app.include_router(layouts.router, prefix="/api/v1")

# Socket.IO í†µí•©
socket_app = socketio.ASGIApp(websocket.sio, app)
```

**ì£¼ìš” ê¸°ëŠ¥**:
- CORS ì„¤ì •ìœ¼ë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ê·¼ í—ˆìš©
- API ë¼ìš°í„° ë“±ë¡
- Socket.IO ì„œë²„ í†µí•©
- Health check ì—”ë“œí¬ì¸íŠ¸

---

### 2. config.py - í™˜ê²½ ì„¤ì •

**ì—­í• **: í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ ë° ì„¤ì • ê´€ë¦¬

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    DATABASE_URL: str
    SECRET_KEY: str
    ALGORITHM: str = "HS256"
    ACCESS_TOKEN_EXPIRE_MINUTES: int = 10080
    ALLOWED_ORIGINS: str
    
    class Config:
        env_file = ".env"
```

**ì£¼ìš” ì„¤ì •**:
- `DATABASE_URL`: ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë¬¸ìì—´
- `SECRET_KEY`: JWT ì„œëª… í‚¤
- `ALGORITHM`: JWT ì•Œê³ ë¦¬ì¦˜ (HS256)
- `ACCESS_TOKEN_EXPIRE_MINUTES`: í† í° ë§Œë£Œ ì‹œê°„ (7ì¼)
- `ALLOWED_ORIGINS`: CORS í—ˆìš© ì˜¤ë¦¬ì§„

---

### 3. database.py - ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

**ì—­í• **: SQLAlchemy ì—”ì§„ ìƒì„± ë° ì„¸ì…˜ ê´€ë¦¬

```python
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from sqlalchemy.ext.declarative import declarative_base

engine = create_engine(
    settings.DATABASE_URL,
    connect_args={"check_same_thread": False}  # SQLiteìš©
)

SessionLocal = sessionmaker(bind=engine)
Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

**ì£¼ìš” ê¸°ëŠ¥**:
- DB ì—”ì§„ ìƒì„±
- ì„¸ì…˜ íŒ©í† ë¦¬ ìƒì„±
- `get_db()` ì˜ì¡´ì„± í•¨ìˆ˜ (FastAPIì—ì„œ ì‚¬ìš©)

**í™•ì¥ì„±**:
- SQLite â†’ PostgreSQL/MySQL ì „í™˜ ì‹œ `DATABASE_URL`ë§Œ ë³€ê²½
- ëª¨ë“  ëª¨ë¸ì€ SQLAlchemy ORM í‘œì¤€ ì‚¬ìš©

---

### 4. core/security.py - ë³´ì•ˆ

**ì—­í• **: JWT í† í° ìƒì„±/ê²€ì¦, ë¹„ë°€ë²ˆí˜¸ í•´ì‹±

```python
from passlib.context import CryptContext
from jose import jwt

pwd_context = CryptContext(schemes=["bcrypt"])

def get_password_hash(password: str) -> str:
    return pwd_context.hash(password)

def verify_password(plain: str, hashed: str) -> bool:
    return pwd_context.verify(plain, hashed)

def create_access_token(data: dict) -> str:
    payload = data.copy()
    payload.update({"exp": datetime.utcnow() + timedelta(...)})
    return jwt.encode(payload, SECRET_KEY, algorithm=ALGORITHM)
```

**ì£¼ìš” ê¸°ëŠ¥**:
- ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (bcrypt)
- JWT í† í° ìƒì„±
- JWT í† í° ê²€ì¦

---

### 5. core/collision.py - ì¶©ëŒ ê°ì§€

**ì—­í• **: ê°€êµ¬ ê°„ ì¶©ëŒ ë° ê²½ê³„ ê²€ì‚¬

```python
class BoundingBox:
    def __init__(self, position, dimensions, rotation):
        self.position = np.array([position['x'], position['y'], position['z']])
        self.dimensions = np.array([dimensions['width'], dimensions['height'], dimensions['depth']])
    
    def get_2d_box(self):
        # XZ í‰ë©´ ë°”ìš´ë”© ë°•ìŠ¤ ê³„ì‚°
        half_width = self.dimensions[0] / 2
        half_depth = self.dimensions[2] / 2
        return (x_min, z_min, x_max, z_max)

def check_collision(box1, box2):
    # Shapelyë¥¼ ì‚¬ìš©í•œ 2D ì¶©ëŒ ê²€ì‚¬
    poly1 = shapely_box(*box1.get_2d_box())
    poly2 = shapely_box(*box2.get_2d_box())
    return poly1.intersects(poly2)
```

**ì£¼ìš” ê¸°ëŠ¥**:
- 2D ë°”ìš´ë”© ë°•ìŠ¤ ê³„ì‚° (XZ í‰ë©´)
- ì¶©ëŒ ê²€ì‚¬ (Shapely ë¼ì´ë¸ŒëŸ¬ë¦¬)
- ê²½ê³„ ê²€ì‚¬ (ë°© ë°–ìœ¼ë¡œ ë‚˜ê°€ëŠ”ì§€)
- ì „ì²´ ë ˆì´ì•„ì›ƒ ê²€ì¦

---

## ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë¸

### 1. User (ì‚¬ìš©ì)

```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True, index=True)
    password_hash = Column(String)
    full_name = Column(String, nullable=True)
    is_active = Column(Boolean, default=True)
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())
    
    # Relationships
    projects = relationship("Project", back_populates="owner")
```

**í•„ë“œ**:
- `id`: ê¸°ë³¸ í‚¤
- `email`: ì´ë©”ì¼ (ê³ ìœ , ì¸ë±ìŠ¤)
- `password_hash`: í•´ì‹œëœ ë¹„ë°€ë²ˆí˜¸
- `full_name`: ì‚¬ìš©ì ì´ë¦„ (ì„ íƒ)
- `is_active`: í™œì„± ìƒíƒœ
- `created_at`, `updated_at`: íƒ€ì„ìŠ¤íƒ¬í”„

---

### 2. Project (í”„ë¡œì íŠ¸)

```python
class Project(Base):
    __tablename__ = "projects"
    
    id = Column(Integer, primary_key=True)
    owner_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"))
    name = Column(String)
    description = Column(String, nullable=True)
    room_width = Column(Float)
    room_height = Column(Float)
    room_depth = Column(Float)
    
    # PLY file support
    has_ply_file = Column(Boolean, default=False, nullable=False)
    ply_file_path = Column(String, nullable=True)
    ply_file_size = Column(Integer, nullable=True)
    
    created_at = Column(DateTime, server_default=func.now())
    updated_at = Column(DateTime, onupdate=func.now())
    
    # Relationships
    owner = relationship("User", back_populates="projects")
    layouts = relationship("Layout", back_populates="project")
```

**í•„ë“œ**:
- `id`: ê¸°ë³¸ í‚¤
- `owner_id`: ì†Œìœ ì ID (ì™¸ë˜ í‚¤)
- `name`: í”„ë¡œì íŠ¸ ì´ë¦„
- `description`: ì„¤ëª… (ì„ íƒ)
- `room_width`, `room_height`, `room_depth`: ë°© í¬ê¸°
- `has_ply_file`: PLY íŒŒì¼ ì¡´ì¬ ì—¬ë¶€
- `ply_file_path`: PLY íŒŒì¼ ì €ì¥ ê²½ë¡œ
- `ply_file_size`: PLY íŒŒì¼ í¬ê¸° (bytes)
- `created_at`, `updated_at`: íƒ€ì„ìŠ¤íƒ¬í”„

---

### 3. Layout (ë ˆì´ì•„ì›ƒ)

```python
class Layout(Base):
    __tablename__ = "layouts"
    
    id = Column(Integer, primary_key=True)
    project_id = Column(Integer, ForeignKey("projects.id", ondelete="CASCADE"))
    version = Column(Integer)
    furniture_state = Column(JSONEncodedDict)  # JSON as TEXT
    is_current = Column(Boolean, default=False)
    created_at = Column(DateTime, server_default=func.now())
    
    # Relationships
    project = relationship("Project", back_populates="layouts")
```

**í•„ë“œ**:
- `id`: ê¸°ë³¸ í‚¤
- `project_id`: í”„ë¡œì íŠ¸ ID (ì™¸ë˜ í‚¤)
- `version`: ë²„ì „ ë²ˆí˜¸
- `furniture_state`: ê°€êµ¬ ìƒíƒœ (JSON)
- `is_current`: í˜„ì¬ ë ˆì´ì•„ì›ƒ ì—¬ë¶€
- `created_at`: ìƒì„± ì‹œê°„

**furniture_state êµ¬ì¡°**:
```json
{
  "furnitures": [
    {
      "id": "bed-single-1234567890",
      "type": "bed",
      "position": {"x": 0, "y": 0.25, "z": 0},
      "rotation": {"x": 0, "y": 0, "z": 0},
      "scale": {"x": 1, "y": 1, "z": 1},
      "dimensions": {"width": 1.0, "height": 0.5, "depth": 2.0},
      "color": "#8B4513"
    }
  ]
}
```

---

### 4. History (íˆìŠ¤í† ë¦¬)

```python
class History(Base):
    __tablename__ = "history"
    
    id = Column(Integer, primary_key=True)
    layout_id = Column(Integer, ForeignKey("layouts.id", ondelete="CASCADE"))
    user_id = Column(Integer, ForeignKey("users.id", ondelete="CASCADE"))
    change_type = Column(String)  # 'add', 'move', 'delete', 'update'
    before_state = Column(JSONEncodedDict, nullable=True)
    after_state = Column(JSONEncodedDict, nullable=True)
    timestamp = Column(DateTime, server_default=func.now())
```

**í•„ë“œ**:
- `id`: ê¸°ë³¸ í‚¤
- `layout_id`: ë ˆì´ì•„ì›ƒ ID (ì™¸ë˜ í‚¤)
- `user_id`: ì‚¬ìš©ì ID (ì™¸ë˜ í‚¤)
- `change_type`: ë³€ê²½ ìœ í˜•
- `before_state`, `after_state`: ë³€ê²½ ì „í›„ ìƒíƒœ
- `timestamp`: ë³€ê²½ ì‹œê°„

---

## API ì—”ë“œí¬ì¸íŠ¸

### ì¸ì¦ (auth.py)

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… |
|--------|------|------|
| POST | `/api/v1/auth/register` | íšŒì›ê°€ì… |
| POST | `/api/v1/auth/login` | ë¡œê·¸ì¸ (JWT ë°œê¸‰) |
| GET | `/api/v1/auth/me` | í˜„ì¬ ì‚¬ìš©ì ì¡°íšŒ |

### í”„ë¡œì íŠ¸ (projects.py)

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… |
|--------|------|------|
| GET | `/api/v1/projects` | í”„ë¡œì íŠ¸ ëª©ë¡ |
| POST | `/api/v1/projects` | í”„ë¡œì íŠ¸ ìƒì„± |
| GET | `/api/v1/projects/{id}` | í”„ë¡œì íŠ¸ ìƒì„¸ |
| PUT | `/api/v1/projects/{id}` | í”„ë¡œì íŠ¸ ìˆ˜ì • |
| DELETE | `/api/v1/projects/{id}` | í”„ë¡œì íŠ¸ ì‚­ì œ |

### ë ˆì´ì•„ì›ƒ (layouts.py)

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… |
|--------|------|------|
| GET | `/api/v1/projects/{id}/layouts/current` | í˜„ì¬ ë ˆì´ì•„ì›ƒ |
| POST | `/api/v1/projects/{id}/layouts` | ë ˆì´ì•„ì›ƒ ì €ì¥ |
| GET | `/api/v1/projects/{id}/layouts` | ë ˆì´ì•„ì›ƒ ëª©ë¡ |
| POST | `/api/v1/projects/{id}/layouts/{layout_id}/restore` | ë ˆì´ì•„ì›ƒ ë³µì› |
| POST | `/api/v1/validate` | ë ˆì´ì•„ì›ƒ ê²€ì¦ |

### íŒŒì¼ (files.py)

| ë©”ì„œë“œ | ê²½ë¡œ | ì„¤ëª… |
|--------|------|------|
| POST | `/api/v1/files/upload-ply/{project_id}` | PLY íŒŒì¼ ì—…ë¡œë“œ |
| GET | `/api/v1/files/ply/{project_id}` | PLY íŒŒì¼ ì •ë³´ ì¡°íšŒ |
| DELETE | `/api/v1/files/ply/{project_id}` | PLY íŒŒì¼ ì‚­ì œ |

---

## WebSocket ì´ë²¤íŠ¸

### í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„

| ì´ë²¤íŠ¸ | ë°ì´í„° | ì„¤ëª… |
|--------|--------|------|
| `join_project` | `{project_id, user_id}` | í”„ë¡œì íŠ¸ ë£¸ ì°¸ê°€ |
| `furniture_move` | `{project_id, furniture_id, position, rotation}` | ê°€êµ¬ ì´ë™ |
| `furniture_add` | `{project_id, furniture}` | ê°€êµ¬ ì¶”ê°€ |
| `furniture_delete` | `{project_id, furniture_id}` | ê°€êµ¬ ì‚­ì œ |
| `validate_furniture` | `{project_id, furniture_state, room_dimensions}` | ë ˆì´ì•„ì›ƒ ê²€ì¦ |

### ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸

| ì´ë²¤íŠ¸ | ë°ì´í„° | ì„¤ëª… |
|--------|--------|------|
| `user_joined` | `{user_id, sid}` | ì‚¬ìš©ì ì°¸ê°€ ì•Œë¦¼ |
| `user_left` | `{sid}` | ì‚¬ìš©ì í‡´ì¥ ì•Œë¦¼ |
| `furniture_updated` | `{furniture_id, position, rotation}` | ê°€êµ¬ ì—…ë°ì´íŠ¸ |
| `furniture_added` | `{furniture}` | ê°€êµ¬ ì¶”ê°€ ì•Œë¦¼ |
| `furniture_deleted` | `{furniture_id}` | ê°€êµ¬ ì‚­ì œ ì•Œë¦¼ |
| `validation_result` | `{valid, collisions, out_of_bounds}` | ê²€ì¦ ê²°ê³¼ |
| `collision_detected` | `{collisions, out_of_bounds}` | ì¶©ëŒ ê°ì§€ ì•Œë¦¼ |

---

## ë‹¤ìŒ ë‹¨ê³„

- [í”„ë¡ íŠ¸ì—”ë“œ êµ¬ì¡°](./03_í”„ë¡ íŠ¸ì—”ë“œ_êµ¬ì¡°.md) ì´í•´í•˜ê¸°
- [ë°ì´í„° íë¦„](./04_ë°ì´í„°_íë¦„.md) íŒŒì•…í•˜ê¸°
- [API ë¬¸ì„œ](./05_API_ë¬¸ì„œ.md) ìƒì„¸ ì°¸ì¡°
